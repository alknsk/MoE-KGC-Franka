2025-07-05 14:52:20 - moe_kgc - INFO - Logging to experiments/moe_kgc_batch_experiment/logs/moe_kgc_20250705_145220.log
2025-07-05 14:52:20 - moe_kgc - INFO - 开始实验: moe_kgc_batch_experiment
2025-07-05 14:52:20 - moe_kgc - INFO - 使用设备: cuda
2025-07-05 14:52:20 - moe_kgc - INFO - 加载数据...
2025-07-05 14:52:20 - moe_kgc - INFO - 加载预处理的PyG数据...
2025-07-05 14:52:20 - moe_kgc - INFO - 创建mini-batch数据加载器...
/home2/yanghaochen/anaconda3/envs/franka/lib/python3.12/site-packages/torch_geometric/sampler/neighbor_sampler.py:50: UserWarning: Using '{self.__class__.__name__}' without a 'pyg-lib' installation is deprecated and will be removed soon. Please install 'pyg-lib' for accelerated neighborhood sampling
  warnings.warn("Using '{self.__class__.__name__}' without a "
2025-07-05 14:52:20 - moe_kgc - INFO - 数据加载完成:
2025-07-05 14:52:20 - moe_kgc - INFO -   训练批次数: 7827
2025-07-05 14:52:20 - moe_kgc - INFO -   验证批次数: 534
2025-07-05 14:52:20 - moe_kgc - INFO -   测试批次数: 509
2025-07-05 14:52:20 - moe_kgc - INFO - 初始化模型...
可用的CUDA设备数量: 5
设备 0: NVIDIA A40
设备 1: NVIDIA A40
设备 2: NVIDIA A40
设备 3: NVIDIA A40
设备 4: NVIDIA A40
2025-07-05 14:52:20 - moe_kgc - INFO - 检测到5个GPU设备
2025-07-05 14:52:20 - moe_kgc - INFO - GPU 0: 已使用 0.00GB / 44.34GB (0.0%)
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 1: 已使用 0.00GB / 44.34GB (0.0%)
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 2: 已使用 0.00GB / 44.34GB (0.0%)
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 3: 已使用 0.00GB / 47.32GB (0.0%)
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 4: 已使用 0.00GB / 44.34GB (0.0%)
2025-07-05 14:52:21 - moe_kgc - WARNING - 可用GPU不足，循环使用GPU: [0, 1, 2, 3, 4]，避开0号GPU
2025-07-05 14:52:21 - moe_kgc - INFO - 成功分配设备：['cuda:0', 'cuda:1', 'cuda:2', 'cuda:3', 'cuda:4', 'cuda:0']
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 0 内存状态: 已分配=0.00GB, 已缓存=0.00GB, 总计=44.34GB
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 1 内存状态: 已分配=0.00GB, 已缓存=0.00GB, 总计=44.34GB
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 2 内存状态: 已分配=0.00GB, 已缓存=0.00GB, 总计=44.34GB
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 3 内存状态: 已分配=0.00GB, 已缓存=0.00GB, 总计=47.32GB
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 4 内存状态: 已分配=0.00GB, 已缓存=0.00GB, 总计=44.34GB
2025-07-05 14:52:21 - moe_kgc - INFO - GPU 0 内存状态: 已分配=0.00GB, 已缓存=0.00GB, 总计=44.34GB
/home2/yanghaochen/anaconda3/envs/franka/lib/python3.12/site-packages/torch/nn/modules/transformer.py:379: UserWarning: enable_nested_tensor is True, but self.use_nested_tensor is False because encoder_layer.self_attn.batch_first was not True(use batch_first for better inference performance)
  warnings.warn(
2025-07-05 14:52:27 - moe_kgc - INFO - 模型参数量: 119,262,990
weight_decay: 1e-5 <class 'str'>
2025-07-05 14:52:27 - moe_kgc - INFO - 开始训练...
Epoch 0:   0%|          | 0/7827 [00:00<?, ?it/s][Expert Debug] input dtype: torch.float16, mlp weight dtype: torch.float32
[Expert Debug] input dtype: torch.float16, mlp weight dtype: torch.float32
[Expert Debug] input dtype: torch.float16, mlp weight dtype: torch.float32
[Expert Debug] input dtype: torch.float16, mlp weight dtype: torch.float32
[Expert Debug] input dtype: torch.float16, mlp weight dtype: torch.float32
[DEBUG] input x shape: torch.Size([111, 128])
[DEBUG] edge_index shape: torch.Size([2, 0]), (empty)
[DEBUG] batch shape: torch.Size([111]), batch.max: 0, batch.min: 0
[DEBUG] after input_proj, x shape: torch.Size([111, 128])
[DEBUG] after GNN layer 0, x shape: torch.Size([111, 128]), x.mean: -0.0008
[DEBUG] before pooling, x shape: torch.Size([111, 128]), batch shape: torch.Size([111])
Epoch 0:   0%|          | 0/7827 [00:01<?, ?it/s]
Traceback (most recent call last):
  File "/home2/yanghaochen/MoE_franka/scripts/train_e2e.py", line 326, in <module>
    main()
  File "/home2/yanghaochen/MoE_franka/scripts/train_e2e.py", line 264, in main
    history = trainer.train(
              ^^^^^^^^^^^^^^
  File "/home2/yanghaochen/MoE_franka/training/trainer.py", line 208, in train
    train_results = self.train_epoch(train_loader, task=task)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/MoE_franka/training/trainer.py", line 96, in train_epoch
    outputs = self.model(batch, task=task)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/anaconda3/envs/franka/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/anaconda3/envs/franka/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/MoE_franka/models/moe_kgc.py", line 426, in forward
    output = self._apply_task_head(node_embeddings, batch_dict, task)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/MoE_franka/models/moe_kgc.py", line 742, in _apply_task_head
    return self.link_prediction_head(head_embeddings, tail_embeddings, relation_ids)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/anaconda3/envs/franka/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/anaconda3/envs/franka/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/MoE_franka/models/task_heads/link_prediction.py", line 151, in forward
    score = self.distmult_score(head_proj, relation_proj, tail_proj)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home2/yanghaochen/MoE_franka/models/task_heads/link_prediction.py", line 74, in distmult_score
    score = (head * relation * tail).sum(dim=-1)
             ~~~~~^~~~~~~~~~
RuntimeError: The size of tensor a (2) must match the size of tensor b (576) at non-singleton dimension 0
